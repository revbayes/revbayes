clear()
seed(54321)

####################
# read in the data #
data <- readDiscreteCharacterData("../tests/data/discrete3.nex")
taxa <- data.taxa()

# global variables
n_taxa <- taxa.size()
relabelled <- data.relabelStates()

# vector for the moves and monitors
moves    = VectorMoves()
monitors = VectorMonitors()

# topology
topology ~ dnUniformTopology(taxa)

moves.append( mvNNI(topology) )
moves.append( mvSPR(topology) )

# branch lengths
n_branches <- 2 * n_taxa - 3
for (i in 1:n_branches) {
   br_lens[i] ~ dnExponential(10.0)
   moves.append( mvScale(br_lens[i]) )
}

# tree length
TL := sum(br_lens)

phylogeny := treeAssembly(topology, br_lens)

# loop over the characters by num state #
# print(data.getObsStatesVector()) # n included: 1, 1, 128, 86, 18, 1
print(relabelled.getNumStatesVector())
stop()
print(relabelled.getObsStatesVector())
partition_vector <- relabelled.getObsStatesVector()
for (pv in 3:partition_vector.size()) {
    i = pv - 2;
    k_obs = i + 1;
    Q[i] := fnJC(k_obs)  # simple Mk model
    
    # create the substitution model and clamp with observed data
    seq_informative[i] ~ dnPhyloCTMC(tree = phylogeny, Q = Q[i], type = "Standard", coding = "nstates")

    partition_vector[pv].removeExcludedCharacters() # Reduce memory footprint; see #552
    relabelled[i] = partition_vector[pv].relabelStates()

    write(i, pv, partition_vector[pv], relabelled[i]) ## TODO remove this temporary check

    seq_informative[i].clamp(relabelled[i])
}

mymodel = model(phylogeny)

############
# run MCMC #

# some minitors
monitors.append( mnScreen(printgen=1) )
monitors.append( mnModel(filename="output/Mkn.log", printgen=1) )
monitors.append( mnFile(filename="output/Mkn.trees", printgen=1, phylogeny) )

# initialize the MCMC object
mymcmc = mcmc(mymodel, moves, monitors)

# run the MCMC
mymcmc.run(generations=10)

#################
# quit RevBayes #
stoq()
